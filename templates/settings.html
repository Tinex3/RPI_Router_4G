{% extends "base.html" %}
{% block title %}Configuracion - EC25 Router{% endblock %}
{% block page_title %}Configuracion del Modem{% endblock %}

{% block content %}
<div class="grid">
  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      Seguridad de Red
    </h2>
    
    <div class="form-group">
      <label class="check">
        <input id="isolate" type="checkbox" {% if cfg.security.isolate_clients %}checked{% endif %}>
        Aislar clientes WiFi
      </label>
      <span class="hint">Evita que los dispositivos conectados se vean entre ellos</span>
    </div>
    
    <button class="btn" onclick="applySecurity()">Aplicar Seguridad</button>
    <div id="security-status" class="status-msg"></div>
  </div>

  <div class="card ec25-only">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
      Configuracion APN
    </h2>
    
    <div class="form-group">
      <label for="apn">APN del Operador</label>
      <input id="apn" class="input" value="{{ cfg.apn }}" placeholder="Ej: wap.tmovil.cl">
      <span class="hint">Configuracion del punto de acceso para datos moviles</span>
    </div>
    
    <button class="btn" onclick="saveAPN()">Guardar APN</button>
    <div id="apn-status" class="status-msg"></div>
  </div>

  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4"></path>
        <path d="M12 8h.01"></path>
      </svg>
      Contrase√±a de acceso Web
    </h2>
    <div class="form-group">
      <label for="webPassword">Contrase√±a actual</label>
      <input id="webPassword" class="input" type="password" value="{{ web_password }}" readonly>
    </div>
    <div class="form-group">
      <label for="newWebPassword">Nueva contrase√±a</label>
      <input id="newWebPassword" class="input" type="password" placeholder="Nueva contrase√±a">
    </div>
    <button class="btn" onclick="changeWebPassword()">Cambiar contrase√±a</button>
    <div id="webpass-status" class="status-msg"></div>
  </div>

  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
        <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
        <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
        <circle cx="12" cy="20" r="1"></circle>
      </svg>
      M√≥dem EC25
    </h2>
    <div class="form-group">
      <label class="check">
        <input id="ec25Enabled" type="checkbox">
        Habilitar m√≥dem EC25
      </label>
      <span class="hint" id="ec25Hint">Cargando estado...</span>
    </div>
    <button class="btn" onclick="toggleEC25()">Guardar</button>
    <div id="ec25-status" class="status-msg"></div>
  </div>

  <!-- Modo Ethernet -->
  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
      Modo Ethernet
    </h2>
    
    <div class="form-group">
      <label>Modo actual</label>
      <div class="mode-indicator" id="eth-mode-current">
        <span class="mode-icon">‚è≥</span>
        <span class="mode-text">Cargando...</span>
      </div>
    </div>
    
    <div class="form-group">
      <span class="hint">
        <strong>WAN (Entrada):</strong> Ethernet recibe internet del router<br>
        <strong>LAN (Salida):</strong> Ethernet comparte internet del EC25 hacia switch/router
      </span>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-success" onclick="setEthMode('wan')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M2 12h20"></path>
        </svg>
        WAN (Entrada)
      </button>
      <button class="btn btn-primary" onclick="setEthMode('lan')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <polyline points="19 12 12 19 5 12"></polyline>
        </svg>
        LAN (Salida)
      </button>
      <button class="btn btn-danger" onclick="fixEthernet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
        </svg>
        Reparar
      </button>
    </div>
    
    <div id="ethernet-status" class="status-msg"></div>
  </div>

  <!-- Modo WAN (Failover) -->
  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
      </svg>
      Modo WAN (Failover)
    </h2>
    
    <div class="form-group">
      <label>Modo activo</label>
      <div class="mode-indicator" id="wan-mode-current">
        <span class="mode-icon">‚è≥</span>
        <span class="mode-text">Cargando...</span>
      </div>
    </div>
    
    <div class="form-group">
      <span class="hint">
        <strong>Ethernet ONLY:</strong> Solo eth0, sin failover autom√°tico<br>
        <strong>LTE ONLY:</strong> Solo EC25, sin failover autom√°tico<br>
        <strong>Auto (Smart):</strong> Prioridad Ethernet, cambia solo cuando falla
      </span>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-success" onclick="setWanMode('ethernet-only')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
          <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        </svg>
        Ethernet ONLY
      </button>
      <button class="btn btn-warning" onclick="setWanMode('lte-only')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
          <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
          <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
        </svg>
        LTE ONLY
      </button>
      <button class="btn btn-purple" onclick="setWanMode('auto-smart')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Auto (Smart)
      </button>
    </div>
    
    <div id="wan-mode-status" class="status-msg"></div>
  </div>
</div>

<script src="/static/js/settings.js"></script>
<script>
// Cargar modos actuales al iniciar
window.addEventListener('DOMContentLoaded', async () => {
  // Modo Ethernet
  try {
    const resp = await fetch('/api/system/eth-mode');
    const data = await resp.json();
    const modeEl = document.getElementById('eth-mode-current');
    if (data.mode === 'lan') {
      modeEl.innerHTML = `
        <span class="mode-icon" style="color: #3498db;">üîå</span>
        <span class="mode-text" style="color: #3498db;">LAN (Salida)</span>
      `;
    } else {
      modeEl.innerHTML = `
        <span class="mode-icon" style="color: #2ecc71;">üåê</span>
        <span class="mode-text" style="color: #2ecc71;">WAN (Entrada)</span>
      `;
    }
  } catch (e) {
    console.error('Error loading eth mode:', e);
  }
  
  // Modo WAN
  try {
    const resp = await fetch('/api/system/wan-mode');
    const data = await resp.json();
    const modeEl = document.getElementById('wan-mode-current');
    const modeConfig = {
      'ethernet-only': { icon: 'üåê', text: 'Ethernet ONLY', color: '#2ecc71' },
      'lte-only': { icon: 'üì°', text: 'LTE ONLY', color: '#e67e22' },
      'auto-smart': { icon: 'üîÑ', text: 'Auto (Smart)', color: '#9b59b6' }
    };
    const config = modeConfig[data.mode] || { icon: '‚ùì', text: data.mode, color: '#95a5a6' };
    modeEl.innerHTML = `
      <span class="mode-icon" style="color: ${config.color};">${config.icon}</span>
      <span class="mode-text" style="color: ${config.color};">${config.text}</span>
    `;
  } catch (e) {
    console.error('Error loading WAN mode:', e);
  }
});

async function setWanMode(mode) {
  const statusEl = document.getElementById('wan-mode-status');
  const modeEl = document.getElementById('wan-mode-current');
  
  const modeConfig = {
    'ethernet-only': { icon: 'üåê', text: 'Ethernet ONLY', color: '#2ecc71' },
    'lte-only': { icon: 'üì°', text: 'LTE ONLY', color: '#e67e22' },
    'auto-smart': { icon: 'üîÑ', text: 'Auto (Smart)', color: '#9b59b6' }
  };
  
  statusEl.textContent = `‚è≥ Configurando ${modeConfig[mode].text}...`;
  statusEl.className = 'status-msg';
  
  try {
    const resp = await fetch('/api/system/set-wan-mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: mode })
    });
    
    const data = await resp.json();
    
    if (data.ok) {
      statusEl.textContent = data.message;
      statusEl.className = 'status-msg success';
      
      // Actualizar indicador de modo
      const config = modeConfig[mode];
      modeEl.innerHTML = `
        <span class="mode-icon" style="color: ${config.color};">${config.icon}</span>
        <span class="mode-text" style="color: ${config.color};">${config.text}</span>
      `;
    } else {
      statusEl.textContent = 'Error: ' + (data.error || 'Operaci√≥n fall√≥');
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi√≥n';
    statusEl.className = 'status-msg error';
    console.error(e);
  }
}

async function setEthMode(mode) {
  const statusEl = document.getElementById('ethernet-status');
  const modeEl = document.getElementById('eth-mode-current');
  
  statusEl.textContent = mode === 'lan' ? 
    '‚è≥ Configurando modo LAN...' : 
    '‚è≥ Configurando modo WAN...';
  statusEl.className = 'status-msg';
  
  try {
    const endpoint = mode === 'lan' ? 
      '/api/system/set-eth-lan' : 
      '/api/system/set-eth-wan';
      
    const resp = await fetch(endpoint, { method: 'POST' });
    const data = await resp.json();
    
    if (data.ok) {
      statusEl.textContent = data.message;
      statusEl.className = 'status-msg success';
      
      // Actualizar indicador de modo
      if (mode === 'lan') {
        modeEl.textContent = 'üîå LAN (Salida)';
        modeEl.style.color = '#2ecc71';
      } else {
        modeEl.textContent = 'üåê WAN (Entrada)';
        modeEl.style.color = '#3498db';
      }
    } else {
      statusEl.textContent = 'Error: ' + (data.error || 'Operaci√≥n fall√≥');
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi√≥n';
    statusEl.className = 'status-msg error';
    console.error(e);
  }
}

async function changeWebPassword() {
  const newPass = document.getElementById('newWebPassword').value.trim();
  const statusEl = document.getElementById('webpass-status');
  if (!newPass) {
    statusEl.textContent = 'La contrase√±a no puede estar vac√≠a';
    statusEl.className = 'status-msg error';
    return;
  }
  try {
    const resp = await fetch('/api/web-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: newPass })
    });
    const data = await resp.json();
    if (data.ok) {
      statusEl.textContent = 'Contrase√±a actualizada correctamente';
      statusEl.className = 'status-msg success';
      document.getElementById('webPassword').value = newPass;
      document.getElementById('newWebPassword').value = '';
    } else {
      statusEl.textContent = data.error || 'Error al actualizar contrase√±a';
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi√≥n';
    statusEl.className = 'status-msg error';
  }
}

async function fixEthernet() {
  const statusEl = document.getElementById('ethernet-status');
  statusEl.textContent = 'Reparando conexi√≥n...';
  statusEl.className = 'status-msg';
  
  try {
    const resp = await fetch('/api/system/fix-ethernet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await resp.json();
    
    if (data.success) {
      statusEl.textContent = data.message || 'Conexi√≥n reparada correctamente';
      statusEl.className = 'status-msg success';
    } else {
      statusEl.textContent = data.message || 'Error al reparar conexi√≥n';
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi√≥n al servidor';
    statusEl.className = 'status-msg error';
  }
}
</script>
{% endblock %}
