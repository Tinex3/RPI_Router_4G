{% extends "base.html" %}
{% block title %}Configuracion - EC25 Router{% endblock %}
{% block page_title %}Configuracion del Modem{% endblock %}

{% block content %}
<div class="grid">
  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      Seguridad de Red
    </h2>
    
    <div class="form-group">
      <label class="check">
        <input id="isolate" type="checkbox" {% if cfg.security.isolate_clients %}checked{% endif %}>
        Aislar clientes WiFi
      </label>
      <span class="hint">Evita que los dispositivos conectados se vean entre ellos</span>
    </div>
    
    <button class="btn" onclick="applySecurity()">Aplicar Seguridad</button>
    <div id="security-status" class="status-msg"></div>
  </div>

  <div class="card ec25-only">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
      Configuracion APN
    </h2>
    
    <div class="form-group">
      <label for="apn">APN del Operador</label>
      <input id="apn" class="input" value="{{ cfg.apn }}" placeholder="Ej: wap.tmovil.cl">
      <span class="hint">Configuracion del punto de acceso para datos moviles</span>
    </div>
    
    <button class="btn" onclick="saveAPN()">Guardar APN</button>
    <div id="apn-status" class="status-msg"></div>
  </div>

  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4"></path>
        <path d="M12 8h.01"></path>
      </svg>
      Contrase帽a de acceso Web
    </h2>
    <div class="form-group">
      <label for="webPassword">Contrase帽a actual</label>
      <input id="webPassword" class="input" type="password" value="{{ web_password }}" readonly>
    </div>
    <div class="form-group">
      <label for="newWebPassword">Nueva contrase帽a</label>
      <input id="newWebPassword" class="input" type="password" placeholder="Nueva contrase帽a">
    </div>
    <button class="btn" onclick="changeWebPassword()">Cambiar contrase帽a</button>
    <div id="webpass-status" class="status-msg"></div>
  </div>

  <div class="card">
    <h2>
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
        <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
        <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
        <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
        <circle cx="12" cy="20" r="1"></circle>
      </svg>
      M贸dem EC25
    </h2>
    <div class="form-group">
      <label class="check">
        <input id="ec25Enabled" type="checkbox">
        Habilitar m贸dem EC25
      </label>
      <span class="hint" id="ec25Hint">Cargando estado...</span>
    </div>
    <button class="btn" onclick="toggleEC25()">Guardar</button>
    <div id="ec25-status" class="status-msg"></div>
  </div>

  <!-- Conexi贸n Ethernet -->
  <div class="card">
    <h2>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
      Conexi贸n Ethernet
    </h2>
    <p class="hint">Si pierdes conexi贸n a Internet por Ethernet, usa este bot贸n para reparar rutas de red duplicadas.</p>
    <button class="btn" onclick="fixEthernet()"> Reparar Conexi贸n</button>
    <div id="ethernet-status" class="status-msg"></div>
  </div>
</div>

<script src="/static/js/settings.js"></script>
<script>
async function changeWebPassword() {
  const newPass = document.getElementById('newWebPassword').value.trim();
  const statusEl = document.getElementById('webpass-status');
  if (!newPass) {
    statusEl.textContent = 'La contrase帽a no puede estar vac铆a';
    statusEl.className = 'status-msg error';
    return;
  }
  try {
    const resp = await fetch('/api/web-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: newPass })
    });
    const data = await resp.json();
    if (data.ok) {
      statusEl.textContent = 'Contrase帽a actualizada correctamente';
      statusEl.className = 'status-msg success';
      document.getElementById('webPassword').value = newPass;
      document.getElementById('newWebPassword').value = '';
    } else {
      statusEl.textContent = data.error || 'Error al actualizar contrase帽a';
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi贸n';
    statusEl.className = 'status-msg error';
  }
}

async function fixEthernet() {
  const statusEl = document.getElementById('ethernet-status');
  statusEl.textContent = 'Reparando conexi贸n...';
  statusEl.className = 'status-msg';
  
  try {
    const resp = await fetch('/api/system/fix-ethernet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await resp.json();
    
    if (data.success) {
      statusEl.textContent = data.message || 'Conexi贸n reparada correctamente';
      statusEl.className = 'status-msg success';
    } else {
      statusEl.textContent = data.message || 'Error al reparar conexi贸n';
      statusEl.className = 'status-msg error';
    }
  } catch (e) {
    statusEl.textContent = 'Error de conexi贸n al servidor';
    statusEl.className = 'status-msg error';
  }
}
</script>
{% endblock %}
